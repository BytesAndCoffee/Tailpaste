#!/usr/bin/env bash
# load_remote_secret

set -euo pipefail

# Absolute safety check
if [[ -n "${GITHUB_ACTIONS:-}" ]]; then
  echo "❌ Refusing to load Tailscale authkey in GitHub Actions"
  exit 1
fi

# Optional: explicit opt-in
if [[ "${LOCAL_TAILSCALE_AUTHKEY:-}" != "1" ]]; then
  echo "ℹ️ LOCAL_TAILSCALE_AUTHKEY not set, skipping Tailscale authkey load"
  return 0
fi

# Fetch from server
AUTHKEY=$(ssh docker \
  "sed -n 's/^TAILSCALE_AUTHKEY=//p' ~/tailpaste/.env" \
  2>/dev/null || true)

if [[ -z "$AUTHKEY" ]]; then
  echo "❌ Failed to retrieve TAILSCALE_AUTHKEY via SSH"
  exit 1
fi

export TAILSCALE_AUTHKEY="$AUTHKEY"
echo "✅ Loaded Tailscale authkey for local CI"