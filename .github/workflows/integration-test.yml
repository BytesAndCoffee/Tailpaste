name: Integration Tests

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  integration-test:
    name: Integration Testing
    runs-on:
      - tailpaste-runners
    
    permissions:
      contents: read
      actions: write
    
    # Only run if triggered by schedule/dispatch OR if CI workflow succeeded
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    
    outputs:
      test-status: ${{ steps.test-results.outputs.status }}
      artifact-digest: ${{ steps.get-artifact.outputs.digest }}
      deployable: ${{ steps.mark-deployable.outputs.deployable }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install GitHub CLI
        run: |
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Download artifact metadata from CI workflow
        run: |
          gh run download "${{ github.event.workflow_run.id }}" \
            --name artifact-metadata \
            --dir . || echo "Warning: Could not download artifact metadata"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get artifact digest from CI workflow
        id: get-artifact
        run: |
          source .github/scripts/integration-test/it-get-artifact.sh \
            "${{ github.event.workflow_run.id }}" \
            "${{ github.event.workflow_run.head_sha }}" \
            "${{ env.REGISTRY }}" \
            "${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update artifact status to testing
        run: |
          .github/scripts/integration-test/it-update-status.sh "${{ steps.get-artifact.outputs.digest }}"

      - name: Ensure iptables and ping are installed
        run: |
          .github/scripts/integration-test/it-install-tools.sh
      
      - name: Check for elevation
        run: |
          .github/scripts/integration-test/it-check-elevation.sh
        
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          ping: docker.tailfa875.ts.net
      
      - name: Set up Docker context for remote Docker host
        run: |
          docker context create remote-build --docker "host=tcp://docker:2376" || true
          docker context use remote-build
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          endpoint: remote-build

      - name: Pull and run exact artifact for testing
        run: |
          .github/scripts/integration-test/it-pull-artifact.sh \
            "${{ steps.get-artifact.outputs.digest }}" \
            "${{ env.REGISTRY }}" \
            "${{ env.IMAGE_NAME }}"
      
      - name: Wait for Tailpaste
        run: |
          .github/scripts/integration-test/it-wait-service.sh
      
      - name: Run integration tests
        run: |
          .github/scripts/integration-test/it-run-tests.sh
      
      - name: Test large paste handling
        run: |
          .github/scripts/integration-test/it-test-large-paste.sh
      
      - name: Test security and concurrent requests
        run: |
          .github/scripts/integration-test/it-test-security.sh
      
      - name: Record integration test results
        id: test-results
        if: always()
        run: |
          source .github/scripts/integration-test/it-record-results.sh \
            "${{ job.status }}" \
            "${{ steps.get-artifact.outputs.digest }}" >> $GITHUB_OUTPUT

      - name: Mark artifact as deployable or failed
        id: mark-deployable
        if: always()
        run: |
          source .github/scripts/integration-test/it-mark-deployable.sh \
            "${{ steps.test-results.outputs.status }}" \
            "${{ steps.get-artifact.outputs.digest }}" >> $GITHUB_OUTPUT

      - name: Store deployment status in repository variable
        if: always()
        run: |
          COMMIT_SHA="${{ github.event.workflow_run.head_sha || github.sha }}"
          DIGEST="${{ steps.get-artifact.outputs.digest }}"
          STATUS="${{ steps.test-results.outputs.status }}"
          
          echo "üì¶ Storing deployment status for commit $COMMIT_SHA"
          
          if [ "$STATUS" = "passed" ]; then
            gh variable set "ARTIFACT_${COMMIT_SHA}_STATUS" --body "deployable" --repo ${{ github.repository }}
            echo "‚úÖ Artifact marked as deployable"
          else
            gh variable set "ARTIFACT_${COMMIT_SHA}_STATUS" --body "failed" --repo ${{ github.repository }}
            echo "‚ùå Artifact marked as failed"
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Integration test summary
        if: always()
        run: |
          .github/scripts/integration-test/it-generate-summary.sh \
            "${{ steps.get-artifact.outputs.digest }}" \
            "${{ steps.test-results.outputs.status }}" \
            "${{ steps.mark-deployable.outputs.deployable }}"
