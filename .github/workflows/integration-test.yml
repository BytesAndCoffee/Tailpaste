name: Integration Tests

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  integration-test:
    name: Integration Testing
    runs-on:
      - tailpaste-runners
    
    # Only run if triggered by schedule/dispatch OR if CI workflow succeeded
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    
    outputs:
      test-status: ${{ steps.test-results.outputs.status }}
      artifact-digest: ${{ steps.get-artifact.outputs.digest }}
      deployable: ${{ steps.mark-deployable.outputs.deployable }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get artifact digest from CI workflow
        id: get-artifact
        run: |
          echo "üîç Retrieving artifact digest from CI workflow..."
          
          # Get the CI workflow run that triggered this integration test
          CI_RUN_ID="${{ github.event.workflow_run.id }}"
          
          # Download CI workflow artifacts to get the digest
          gh run download $CI_RUN_ID --name coverage-reports --dir /tmp/ci-artifacts || true
          
          # Get artifact digest from artifact manager
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          DIGEST=$(python scripts/artifact_manager.py get-digest --commit $COMMIT_SHA 2>/dev/null || echo "")
          
          if [ -z "$DIGEST" ]; then
            echo "‚ùå No artifact digest found for commit $COMMIT_SHA"
            echo "This indicates the CI workflow did not create an artifact (likely due to CI gating failure)"
            exit 1
          fi
          
          echo "‚úÖ Found artifact digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          
          # Validate the digest format
          python scripts/artifact_manager.py validate-digest \
            --digest "$DIGEST" \
            --registry ${{ env.REGISTRY }} \
            --repository ${{ env.IMAGE_NAME }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update artifact status to testing
        run: |
          echo "üìù Marking artifact as under integration testing..."
          python scripts/artifact_manager.py update-status \
            --digest ${{ steps.get-artifact.outputs.digest }} \
            --status testing \
            --timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Ensure iptables and ping are installed
        run: |
          if ! command -v iptables > /dev/null; then
            sudo apt-get update && sudo apt-get install -y iptables
          fi
      
      - name: Check for elevation
        run: |
          if [ "$EUID" -ne 0 ]; then
            echo "‚ùå This job requires elevated privileges."
            echo "Checking sudo access..."
            echo "Elevated user: $(sudo whoami)"
          fi
          echo "‚úì Running with elevated privileges."
          sudo which iptables
        
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          ping: tailpaste.tailfa875.ts.net

      - name: Pull and run exact artifact for testing
        run: |
          echo "üê≥ Pulling exact artifact for integration testing..."
          ARTIFACT_DIGEST="${{ steps.get-artifact.outputs.digest }}"
          FULL_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${ARTIFACT_DIGEST}"
          
          echo "Pulling image: $FULL_IMAGE"
          docker pull "$FULL_IMAGE"
          
          # Tag the image for easier reference in tests
          docker tag "$FULL_IMAGE" tailpaste-integration-test:latest
          
          echo "‚úÖ Artifact pulled and tagged for testing"
          
          # Verify we're using the exact digest
          PULLED_DIGEST=$(docker inspect "$FULL_IMAGE" --format='{{index .RepoDigests 0}}' | cut -d'@' -f2)
          if [ "$PULLED_DIGEST" != "$ARTIFACT_DIGEST" ]; then
            echo "‚ùå Digest mismatch! Expected: $ARTIFACT_DIGEST, Got: $PULLED_DIGEST"
            exit 1
          fi
          echo "‚úÖ Digest verification passed"
      
      - name: Wait for Tailpaste
        run: |
          echo "‚è≥ Waiting for Tailpaste service to be reachable..."
          for i in {1..90}; do
            if curl -f -s -o /dev/null http://tailpaste:8080/; then
              echo "Tailpaste is up"
              exit 0
            fi
            sleep 1
          done
          echo "Tailpaste failed to start"
      
      - name: Run integration tests
        run: |
          echo "üîç Testing service availability..."
          if ! curl -f -s -o /dev/null http://tailpaste:8080/; then
            echo "‚ùå Service is not reachable"
          fi
          echo "‚úì Service is reachable"
          
          echo "üìù Testing paste creation and retrieval..."
          TEST_CONTENT="Integration Test - $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          PASTE_URL=$(curl -s -X POST -H "Content-Type: text/plain" -d "$TEST_CONTENT" http://tailpaste:8080/)
          
          if [ -z "$PASTE_URL" ]; then
            echo "‚ùå Failed to create paste"
            exit 1
          fi
          echo "‚úì Created paste: $PASTE_URL"
          
          RETRIEVED=$(curl -s "$PASTE_URL")
          if [[ "$RETRIEVED" == *"$TEST_CONTENT"* ]]; then
            echo "‚úì Paste content verified"
          else
            echo "‚ùå Paste content mismatch"
            exit 1
          fi
      
      - name: Test large paste handling
        run: |
          echo "üì¶ Testing large paste (500KB)..."
          dd if=/dev/urandom bs=1024 count=500 2>/dev/null | base64 > /tmp/large_test.txt
          
          PASTE_URL=$(curl -s -X POST -H "Content-Type: text/plain" --data-binary @/tmp/large_test.txt http://tailpaste:8080/)
          
          if [ -z "$PASTE_URL" ]; then
            echo "‚ùå Failed to create large paste"
            rm -f /tmp/large_test.txt
            exit 1
          fi
          echo "‚úì Created large paste: $PASTE_URL"
          
          curl -s -o /tmp/retrieved.txt "$PASTE_URL"
          if [ -s /tmp/retrieved.txt ]; then
            ORIGINAL_SIZE=$(wc -c < /tmp/large_test.txt)
            RETRIEVED_SIZE=$(wc -c < /tmp/retrieved.txt)
            echo "‚úì Retrieved paste (Original: $ORIGINAL_SIZE bytes, Retrieved: $RETRIEVED_SIZE bytes)"
          else
            echo "‚ùå Failed to retrieve large paste"
            exit 1
          fi
          
          rm -f /tmp/large_test.txt /tmp/retrieved.txt
      
      - name: Test security and concurrent requests
        run: |
          echo "‚ö° Testing concurrent requests..."
          for i in $(seq 1 10); do
            (curl -s -X POST -H "Content-Type: text/plain" -d "Concurrent test $i" http://tailpaste:8080/ > /dev/null) &
          done
          wait
          echo "‚úì Concurrent requests completed"
          
          echo "üîí Testing proxy header rejection..."
          HEADERS=("X-Forwarded-For: 1.2.3.4" "X-Real-IP: 1.2.3.4" "X-Forwarded-Proto: https")
          
          for HEADER in "${HEADERS[@]}"; do
            HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null -X POST -H "Content-Type: text/plain" -H "$HEADER" -d "Should be rejected" https://paste.bytes.coffee/)
            
            if [ "$HTTP_CODE" = "403" ]; then
              echo "‚úì Correctly rejected request with: $HEADER"
            else
              echo "‚ùå Expected 403, got $HTTP_CODE for: $HEADER"
              exit 1
            fi
          done
      
      - name: Record integration test results
        id: test-results
        if: always()
        run: |
          echo "üìä Recording integration test results..."
          
          TEST_STATUS="${{ job.status }}"
          ARTIFACT_DIGEST="${{ steps.get-artifact.outputs.digest }}"
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          # Determine final test status
          if [ "$TEST_STATUS" = "success" ]; then
            FINAL_STATUS="passed"
            echo "‚úÖ Integration tests PASSED"
          else
            FINAL_STATUS="failed"
            echo "‚ùå Integration tests FAILED"
          fi
          
          echo "status=$FINAL_STATUS" >> $GITHUB_OUTPUT
          
          # Record test outcome in artifact manager
          python scripts/artifact_manager.py record-test-result \
            --digest "$ARTIFACT_DIGEST" \
            --test-type "integration" \
            --status "$FINAL_STATUS" \
            --timestamp "$TIMESTAMP" \
            --details "Integration tests completed with status: $FINAL_STATUS"
          
          echo "üìù Test results recorded for artifact: $ARTIFACT_DIGEST"

      - name: Mark artifact as deployable or failed
        id: mark-deployable
        if: always()
        run: |
          echo "üè∑Ô∏è Updating artifact deployment status..."
          
          TEST_STATUS="${{ steps.test-results.outputs.status }}"
          ARTIFACT_DIGEST="${{ steps.get-artifact.outputs.digest }}"
          
          if [ "$TEST_STATUS" = "passed" ]; then
            # Mark artifact as deployable
            python scripts/artifact_manager.py update-status \
              --digest "$ARTIFACT_DIGEST" \
              --status "deployable" \
              --timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            
            echo "‚úÖ Artifact marked as DEPLOYABLE"
            echo "deployable=true" >> $GITHUB_OUTPUT
          else
            # Mark artifact as failed
            python scripts/artifact_manager.py update-status \
              --digest "$ARTIFACT_DIGEST" \
              --status "failed" \
              --timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            
            echo "‚ùå Artifact marked as FAILED - deployment blocked"
            echo "deployable=false" >> $GITHUB_OUTPUT
          fi

      - name: Integration test summary
        if: always()
        run: |
          echo "================================"
          echo "Integration Test Summary"
          echo "Artifact Digest: ${{ steps.get-artifact.outputs.digest }}"
          echo "Test Status: ${{ steps.test-results.outputs.status }}"
          echo "Deployable: ${{ steps.mark-deployable.outputs.deployable }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "================================"
          
          # Add to GitHub Step Summary
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact Digest**: \`${{ steps.get-artifact.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Status**: ${{ steps.test-results.outputs.status == 'passed' && '‚úÖ PASSED' || '‚ùå FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployable**: ${{ steps.mark-deployable.outputs.deployable == 'true' && '‚úÖ YES' || '‚ùå NO' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test-results.outputs.status }}" = "failed" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Deployment Blocked**: Integration tests failed. The artifact will not be deployed." >> $GITHUB_STEP_SUMMARY
          fi
