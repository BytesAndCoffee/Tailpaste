name: Integration Tests

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  integration-test:
    name: Integration Testing
    runs-on:
      - tailpaste-runners
    
    # Only run if triggered by schedule/dispatch OR if CI workflow succeeded
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    
    outputs:
      test-status: ${{ steps.test-results.outputs.status }}
      artifact-digest: ${{ steps.get-artifact.outputs.digest }}
      deployable: ${{ steps.mark-deployable.outputs.deployable }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get artifact digest from CI workflow
        id: get-artifact
        run: |
          source .github/scripts/it-get-artifact.sh \
            "${{ github.event.workflow_run.id }}" \
            "${{ github.event.workflow_run.head_sha }}" \
            "${{ env.REGISTRY }}" \
            "${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update artifact status to testing
        run: |
          .github/scripts/integration-test/it-update-status.sh "${{ steps.get-artifact.outputs.digest }}"

      - name: Ensure iptables and ping are installed
        run: |
          .github/scripts/integration-test/it-install-tools.sh
      
      - name: Check for elevation
        run: |
          .github/scripts/integration-test/it-check-elevation.sh
        
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          ping: tailpaste.tailfa875.ts.net

      - name: Pull and run exact artifact for testing
        run: |
          .github/scripts/integration-test/it-pull-artifact.sh \
            "${{ steps.get-artifact.outputs.digest }}" \
            "${{ env.REGISTRY }}" \
            "${{ env.IMAGE_NAME }}"
      
      - name: Wait for Tailpaste
        run: |
          .github/scripts/integration-test/it-wait-service.sh
      
      - name: Run integration tests
        run: |
          .github/scripts/integration-test/it-run-tests.sh
      
      - name: Test large paste handling
        run: |
          .github/scripts/integration-test/it-test-large-paste.sh
      
      - name: Test security and concurrent requests
        run: |
          .github/scripts/integration-test/it-test-security.sh
      
      - name: Record integration test results
        id: test-results
        if: always()
        run: |
          source .github/scripts/integration-test/it-record-results.sh \
            "${{ job.status }}" \
            "${{ steps.get-artifact.outputs.digest }}" >> $GITHUB_OUTPUT

      - name: Mark artifact as deployable or failed
        id: mark-deployable
        if: always()
        run: |
          source .github/scripts/integration-test/it-mark-deployable.sh \
            "${{ steps.test-results.outputs.status }}" \
            "${{ steps.get-artifact.outputs.digest }}" >> $GITHUB_OUTPUT

      - name: Integration test summary
        if: always()
        run: |
          .github/scripts/integration-test/it-generate-summary.sh \
            "${{ steps.get-artifact.outputs.digest }}" \
            "${{ steps.test-results.outputs.status }}" \
            "${{ steps.mark-deployable.outputs.deployable }}"
