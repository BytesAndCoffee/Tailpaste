name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      rollback_target:
        description: 'Rollback target (latest-backup, specific-digest, or file-based)'
        required: true
        type: choice
        options:
          - 'latest-backup'
          - 'specific-digest'
          - 'file-based'
        default: 'latest-backup'
      artifact_digest:
        description: 'Specific artifact digest (required if rollback_target is specific-digest)'
        required: false
        type: string
      bypass_verification:
        description: 'Bypass rollback verification (emergency use only)'
        required: false
        type: boolean
        default: false
      bypass_health_checks:
        description: 'Bypass health checks (emergency use only)'
        required: false
        type: boolean
        default: false
      emergency_rollback:
        description: 'Emergency rollback - bypass all safety checks'
        required: false
        type: boolean
        default: false
      rollback_reason:
        description: 'Detailed reason for rollback (required)'
        required: true
        type: string
      skip_backup:
        description: 'Skip creating backup of current state'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Required permissions for the entire workflow
permissions:
  contents: read
  actions: write      # Required to set repository variables
  packages: read

jobs:
  manual-rollback:
    name: Execute Manual Rollback
    runs-on:
      - tailpaste-runners
    
    # Required permissions for rollback workflow
    permissions:
      contents: read
      actions: write      # Required to set repository variables
      packages: read
    
    # Enhanced concurrency control for manual rollbacks
    concurrency:
      group: manual-rollback-${{ github.repository }}
      cancel-in-progress: false
    
    steps:
      - name: Install GitHub CLI
        run: |
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            sudo apt-get update
            sudo apt-get install -y gh
          else
            echo "GitHub CLI already installed"
          fi

      - name: Log manual rollback initiation and validate inputs
        run: |
          # Use extracted script for rollback initialization and validation
          export INPUT_ROLLBACK_REASON="${{ inputs.rollback_reason }}"
          export INPUT_ROLLBACK_TARGET="${{ inputs.rollback_target }}"
          export INPUT_ARTIFACT_DIGEST="${{ inputs.artifact_digest }}"
          export INPUT_BYPASS_VERIFICATION="${{ inputs.bypass_verification }}"
          export INPUT_BYPASS_HEALTH_CHECKS="${{ inputs.bypass_health_checks }}"
          export INPUT_EMERGENCY_ROLLBACK="${{ inputs.emergency_rollback }}"
          export INPUT_SKIP_BACKUP="${{ inputs.skip_backup }}"
          .github/scripts/rollback/mr-log-and-validate.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Acquire rollback lock
        run: |
          .github/scripts/rollback/mr-acquire-lock.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine rollback target artifact
        run: |
          .github/scripts/rollback/mr-determine-target.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Execute manual rollback with bypass support
        run: |
          echo "ðŸ”„ Executing manual rollback with bypass support..."
          
          # Call the main deployment workflow with rollback parameters and bypass flags
          ROLLBACK_PARAMS="{\"rollback\":true,\"artifact_digest\":\"${{ env.TARGET_DIGEST }}\",\"bypass_gating\":true,\"manual_reason\":\"${{ env.ROLLBACK_REASON }}\",\"force_deployment\":false,\"override_circuit_breaker\":false}"
          
          echo "ðŸ“ž Calling deployment workflow with rollback parameters..."
          echo "Parameters: $ROLLBACK_PARAMS"
          
          # Trigger the deployment workflow with rollback parameters
          gh workflow run deploy.yml \
            --repo ${{ github.repository }} \
            --field rollback=true \
            --field artifact_digest="${{ env.TARGET_DIGEST }}" \
            --field bypass_gating=true \
            --field manual_reason="${{ env.ROLLBACK_REASON }}" \
            --field force_deployment=false \
            --field override_circuit_breaker=false
          
          # Wait a moment for the workflow to start
          sleep 5
          
          # Get the workflow run ID of the triggered deployment
          DEPLOYMENT_RUN_ID=$(gh run list --workflow=deploy.yml --limit=1 --json databaseId --jq '.[0].databaseId')
          
          echo "ðŸ”— Deployment workflow triggered: Run ID $DEPLOYMENT_RUN_ID"
          echo "ðŸ“Š Monitor progress: ${{ github.server_url }}/${{ github.repository }}/actions/runs/$DEPLOYMENT_RUN_ID"
          
          # Record the triggered deployment run
          gh variable set MANUAL_ROLLBACK_DEPLOYMENT_RUN_ID --body "$DEPLOYMENT_RUN_ID" --repo ${{ github.repository }}
          
          # Wait for the deployment workflow to complete if not in emergency mode
          if [ "${{ env.EMERGENCY_ROLLBACK }}" != "true" ]; then
            echo "â³ Waiting for rollback deployment to complete..."
            
            # Wait for completion with timeout
            TIMEOUT=1800  # 30 minutes
            ELAPSED=0
            INTERVAL=30
            
            while [ $ELAPSED -lt $TIMEOUT ]; do
              STATUS=$(gh run view $DEPLOYMENT_RUN_ID --json status --jq '.status')
              CONCLUSION=$(gh run view $DEPLOYMENT_RUN_ID --json conclusion --jq '.conclusion')
              
              echo "Rollback status: $STATUS, conclusion: $CONCLUSION (elapsed: ${ELAPSED}s)"
              
              if [ "$STATUS" = "completed" ]; then
                if [ "$CONCLUSION" = "success" ]; then
                  echo "âœ… Rollback deployment completed successfully"
                  gh variable set MANUAL_ROLLBACK_STATUS --body "successful" --repo ${{ github.repository }}
                  break
                else
                  echo "âŒ Rollback deployment failed with conclusion: $CONCLUSION"
                  gh variable set MANUAL_ROLLBACK_STATUS --body "failed" --repo ${{ github.repository }}
                  gh variable set MANUAL_ROLLBACK_FAILURE_REASON --body "deployment_workflow_failed" --repo ${{ github.repository }}
                  exit 1
                fi
              fi
              
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done
            
            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "â° Rollback deployment timed out after ${TIMEOUT}s"
              gh variable set MANUAL_ROLLBACK_STATUS --body "timeout" --repo ${{ github.repository }}
              gh variable set MANUAL_ROLLBACK_FAILURE_REASON --body "deployment_timeout" --repo ${{ github.repository }}
              exit 1
            fi
          else
            echo "ðŸš¨ Emergency rollback mode - not waiting for deployment completion"
            echo "Monitor the deployment manually: ${{ github.server_url }}/${{ github.repository }}/actions/runs/$DEPLOYMENT_RUN_ID"
            gh variable set MANUAL_ROLLBACK_STATUS --body "emergency_triggered" --repo ${{ github.repository }}
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate manual rollback summary
        if: always()
        run: |
          echo "## ðŸ”„ Manual Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get rollback status
          ROLLBACK_STATUS=$(gh variable get MANUAL_ROLLBACK_STATUS --repo ${{ github.repository }} 2>/dev/null || echo "unknown")
          DEPLOYMENT_RUN_ID=$(gh variable get MANUAL_ROLLBACK_DEPLOYMENT_RUN_ID --repo ${{ github.repository }} 2>/dev/null || echo "")
          
          echo "### Rollback Operation Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rollback Status**: $ROLLBACK_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **Operator**: ${{ env.ROLLBACK_ACTOR }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: ${{ env.ROLLBACK_TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason**: ${{ env.ROLLBACK_REASON }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ env.ROLLBACK_TARGET }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ env.TARGET_DIGEST }}" ]; then
            echo "- **Target Artifact**: \`${{ env.TARGET_DIGEST }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$DEPLOYMENT_RUN_ID" ]; then
            echo "- **Deployment Run**: [$DEPLOYMENT_RUN_ID](${{ github.server_url }}/${{ github.repository }}/actions/runs/$DEPLOYMENT_RUN_ID)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Safety Overrides Applied" >> $GITHUB_STEP_SUMMARY
          echo "- **Bypass Verification**: $([ "${{ env.BYPASS_VERIFICATION }}" = "true" ] && echo "âš ï¸ YES" || echo "âŒ NO")" >> $GITHUB_STEP_SUMMARY
          echo "- **Bypass Health Checks**: $([ "${{ env.BYPASS_HEALTH_CHECKS }}" = "true" ] && echo "âš ï¸ YES" || echo "âŒ NO")" >> $GITHUB_STEP_SUMMARY
          echo "- **Emergency Rollback**: $([ "${{ env.EMERGENCY_ROLLBACK }}" = "true" ] && echo "ðŸš¨ YES" || echo "âŒ NO")" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Backup**: $([ "${{ env.SKIP_BACKUP }}" = "true" ] && echo "âš ï¸ YES" || echo "âŒ NO")" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Rollback Outcome" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ] && [ "$ROLLBACK_STATUS" = "successful" ]; then
            echo "âœ… **Manual rollback completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "- Rollback operation executed without errors" >> $GITHUB_STEP_SUMMARY
            echo "- Service should be restored to previous state" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor service health to confirm successful rollback" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ env.EMERGENCY_ROLLBACK }}" = "true" ] && [ "$ROLLBACK_STATUS" = "emergency_triggered" ]; then
            echo "ðŸš¨ **Emergency rollback triggered**" >> $GITHUB_STEP_SUMMARY
            echo "- Emergency rollback has been initiated" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor the deployment workflow for completion" >> $GITHUB_STEP_SUMMARY
            echo "- Verify service health manually after completion" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Manual rollback failed or incomplete**" >> $GITHUB_STEP_SUMMARY
            echo "- Review logs for specific failure details" >> $GITHUB_STEP_SUMMARY
            echo "- Manual intervention may be required" >> $GITHUB_STEP_SUMMARY
            echo "- Consider emergency rollback if service is critical" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Audit Information" >> $GITHUB_STEP_SUMMARY
          echo "This manual rollback operation has been fully logged:" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Audit Variables**: \`MANUAL_ROLLBACK_AUDIT\`, \`MANUAL_ROLLBACK_*\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸ”„ Manual rollback operation completed. All actions have been logged for audit and compliance purposes.*" >> $GITHUB_STEP_SUMMARY
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release rollback lock
        if: always()
        run: |
          echo "ðŸ”“ Releasing rollback lock..."
          
          # Clear rollback lock
          gh variable set ROLLBACK_IN_PROGRESS --body "false" --repo ${{ github.repository }}
          gh variable delete ROLLBACK_STARTED_BY --repo ${{ github.repository }} 2>/dev/null || true
          gh variable delete ROLLBACK_STARTED_AT --repo ${{ github.repository }} 2>/dev/null || true
          gh variable delete ROLLBACK_WORKFLOW_RUN_ID --repo ${{ github.repository }} 2>/dev/null || true
          
          echo "âœ… Rollback lock released"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Manual rollback failure notification
        if: failure()
        run: |
          echo "âŒ Manual rollback failed! Enhanced failure tracking and notification."
          
          # Record comprehensive failure information
          FAILURE_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          gh variable set MANUAL_ROLLBACK_STATUS --body "failed" --repo ${{ github.repository }}
          gh variable set MANUAL_ROLLBACK_FAILURE_TIME --body "$FAILURE_TIMESTAMP" --repo ${{ github.repository }}
          gh variable set MANUAL_ROLLBACK_FAILURE_WORKFLOW --body "${{ github.run_id }}" --repo ${{ github.repository }}
          
          # Generate failure summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš¨ Manual Rollback Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Failure Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Operation Type**: Manual Rollback" >> $GITHUB_STEP_SUMMARY
          echo "- **Failure Time**: $FAILURE_TIMESTAMP" >> $GITHUB_STEP_SUMMARY
          echo "- **Operator**: ${{ env.ROLLBACK_ACTOR }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ env.ROLLBACK_TARGET }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason**: ${{ env.ROLLBACK_REASON }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ env.TARGET_DIGEST }}" ]; then
            echo "- **Target Artifact**: \`${{ env.TARGET_DIGEST }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommended Actions" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ” **Review failure logs** in this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ”„ **Check deployment workflow** if it was triggered" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸš¨ **Consider emergency rollback** if service is critical" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ› ï¸ **Manual intervention** may be required" >> $GITHUB_STEP_SUMMARY
          echo "5. ðŸ“‹ **Verify current service status** manually" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸš¨ Manual rollback failure has been logged. Immediate attention may be required.*" >> $GITHUB_STEP_SUMMARY
          
          echo "ðŸ’¡ Manual rollback failure information recorded. Immediate manual intervention may be required."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}