name: Security & Dependency Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # These jobs run in parallel as they are independent
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on:
      - tailpaste-runners
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit
      
      - name: Run Safety check
        continue-on-error: true
        run: |
          echo "ðŸ”’ Checking dependencies with Safety..."
          safety check --json > safety-report.json || true
          safety check || true
      
      - name: Run pip-audit
        continue-on-error: true
        run: |
          echo "ðŸ” Running pip-audit..."
          pip-audit --desc --output pip-audit-report.txt || true
          cat pip-audit-report.txt || true
      
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            safety-report.json
            pip-audit-report.txt
          retention-days: 90
      
      - name: Generate security summary
        if: always()
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependency Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          
          if [ -f safety-report.json ]; then
            VULN_COUNT=$(cat safety-report.json | python -c "import sys, json; data=json.load(sys.stdin); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
            echo "- Safety scan found: $VULN_COUNT vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f pip-audit-report.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### pip-audit Results" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 20 pip-audit-report.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  code-security-scan:
    name: Code Security Analysis
    runs-on:
      - tailpaste-runners
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install bandit
        run: pip install bandit[toml]
      
      - name: Run Bandit security scan
        continue-on-error: true
        run: |
          echo "ðŸ”’ Running Bandit security scan..."
          bandit -r src/ -ll -f json -o bandit-report.json || true
          bandit -r src/ -ll -f txt -o bandit-report.txt || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Bandit Security Scan" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat bandit-report.txt >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: |
            bandit-report.json
            bandit-report.txt
          retention-days: 90

  docker-security-scan:
    name: Docker Image Security Scan
    runs-on:
      - tailpaste-runners
    if: github.event_name == 'push' || github.event_name == 'schedule'
    
    # IMPORTANT: This job uses labeled Docker resources to prevent production conflicts
    # - Testing resources are tagged with: environment=testing, managed-by=ci
    # - Production resources are protected with: environment=production, managed-by=manual
    # - Cleanup operations only target testing-labeled resources
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1
        with:
          version: latest
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          ping: docker.tailfa875.ts.net
      
      - name: Set up Docker context
        run: |
          docker context create remote-build --docker "host=tcp://docker:2376" || true
          docker context use remote-build
      
      - name: Build Docker image
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          echo "ðŸ³ Building Docker image..."
          docker compose -f docker-compose.test.yml build
      
      - name: Cleanup Docker on remote host (testing only)
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up testing resources only..."
          # Prune ONLY testing-labeled containers and images
          docker ps -a --filter "label=environment=testing" --filter "label=managed-by=ci" -q | xargs -r docker rm -f || true
          docker images --filter "label=environment=testing" --filter "label=managed-by=ci" -q | xargs -r docker rmi -f || true
          echo "âœ… Cleanup complete - production resources preserved"

      - name: Trivy filesystem scan (vuln + secrets)
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          image-ref: 'tailpaste-app:testing'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          skip-dirs: '.git,htmlcov,__pycache__'
      
      - name: Generate security summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Filesystem Security Scan (Vulnerabilities + Secrets)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Trivy filesystem scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- Scan type: Filesystem (avoids Docker layer export)" >> $GITHUB_STEP_SUMMARY
          echo "- Scanners: vulnerability + secret detection" >> $GITHUB_STEP_SUMMARY
          echo "- Severity: HIGH, CRITICAL" >> $GITHUB_STEP_SUMMARY
      
      - name: Cleanup testing environment
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down || true
          # Remove testing containers (with both labels)
          docker ps -a --filter "label=environment=testing" --filter "label=managed-by=ci" -q | xargs -r docker rm -f || true
          # Remove testing images (with both labels)
          docker images --filter "label=environment=testing" --filter "label=managed-by=ci" -q | xargs -r docker rmi -f || true
          # Remove testing volumes (with both labels)
          docker volume ls --filter "label=environment=testing" --filter "label=managed-by=ci" -q | xargs -r docker volume rm || true
          # Remove dangling/untagged images from testing builds only
          docker images --filter "dangling=true" --filter "label=environment=testing" -q | xargs -r docker rmi -f || true

  dependency-update-check:
    name: Check for Dependency Updates
    runs-on:
      - tailpaste-runners
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install pip-tools
        run: pip install pip-tools
      
      - name: Check for outdated packages
        run: |
          echo "ðŸ“¦ Checking for outdated packages..."
          pip list --outdated > outdated-packages.txt || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat outdated-packages.txt >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Upload outdated packages list
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outdated-packages
          path: outdated-packages.txt
          retention-days: 30
