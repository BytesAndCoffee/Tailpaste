name: Workflow Orchestrator

on:
  workflow_dispatch:
    inputs:
      orchestration_action:
        description: 'Orchestration action to perform'
        required: true
        type: choice
        options:
          - 'status-check'
          - 'dependency-validation'
          - 'workflow-health-check'
          - 'emergency-coordination'
          - 'state-synchronization'
        default: 'status-check'
      target_workflow:
        description: 'Target workflow for specific actions'
        required: false
        type: choice
        options:
          - 'ci'
          - 'integration-test'
          - 'deploy'
          - 'health-monitor'
          - 'recovery'
          - 'manual-rollback'
        default: 'all'
      force_coordination:
        description: 'Force coordination even if workflows are running'
        required: false
        type: boolean
        default: false
  schedule:
    # Run orchestration health check every 15 minutes
    - cron: '*/15 * * * *'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  workflow-orchestration:
    name: Workflow Orchestration and Coordination
    runs-on:
      - tailpaste-runners
    
    # Required permissions for orchestration workflow
    permissions:
      contents: read
      actions: write      # Required to set repository variables
    
    # Prevent concurrent orchestration runs
    concurrency:
      group: workflow-orchestration
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install GitHub CLI
        run: |
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            sudo apt-get update
            sudo apt-get install -y gh
          else
            echo "GitHub CLI already installed"
          fi
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-orchestrator-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-orchestrator-
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Initialize orchestration session
        run: |
          export INPUT_ORCHESTRATION_ACTION="${{ inputs.orchestration_action || 'status-check' }}"
          export INPUT_TARGET_WORKFLOW="${{ inputs.target_workflow || 'all' }}"
          export INPUT_FORCE_COORDINATION="${{ inputs.force_coordination }}"
          .github/scripts/workflows/init-orchestration-session.sh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Validate workflow dependencies and state
        id: dependency_validation
        run: |
          echo "ðŸ” Validating workflow dependencies and state..."
          
          # Run orchestration analysis using extracted script
          python3 .github/scripts/workflows/workflow_orchestrator.py > orchestration_report.json
          
          # Parse results using existing scripts
          VALIDATION_STATUS="success"
          CRITICAL_ISSUES=0
          WARNING_ISSUES=0
          
          if [ -f orchestration_report.json ]; then
            # Use workflow status monitor to analyze results
            python scripts/workflows/workflow_status_monitor.py --repo ${{ github.repository }} --json > status_report.json 2>/dev/null || true
            
            # Simple grep-based counting for critical and warning issues
            # Use grep -c which returns 0 if no matches, and capture only the numeric output
            CRITICAL_ISSUES=$(grep -c "CRITICAL:" orchestration_report.json 2>/dev/null || printf "0")
            WARNING_ISSUES=$(grep -c -E "(WARNING:|issues detected|inconsistency)" orchestration_report.json 2>/dev/null || printf "0")
            
            # Ensure variables are valid integers
            CRITICAL_ISSUES=$(printf "%d" "$CRITICAL_ISSUES" 2>/dev/null || printf "0")
            WARNING_ISSUES=$(printf "%d" "$WARNING_ISSUES" 2>/dev/null || printf "0")
            
            if [ "$CRITICAL_ISSUES" -gt 0 ]; then
              VALIDATION_STATUS="critical"
            elif [ "$WARNING_ISSUES" -gt 0 ]; then
              VALIDATION_STATUS="warning"
            fi
            
            echo "âœ… Workflow orchestration analysis completed"
            echo "ðŸ“Š Analysis results:"
            echo "  - Status: $VALIDATION_STATUS"
            echo "  - Critical issues: $CRITICAL_ISSUES"
            echo "  - Warning issues: $WARNING_ISSUES"
          else
            echo "âŒ Orchestration analysis failed"
            VALIDATION_STATUS="failed"
          fi
          
          echo "VALIDATION_STATUS=$VALIDATION_STATUS" >> $GITHUB_OUTPUT
          echo "CRITICAL_ISSUES=$CRITICAL_ISSUES" >> $GITHUB_OUTPUT
          echo "WARNING_ISSUES=$WARNING_ISSUES" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Execute orchestration action
        id: orchestration_action
        run: |
          echo "ðŸŽ¯ Executing orchestration action: $ORCHESTRATION_ACTION"
          
          case "$ORCHESTRATION_ACTION" in
            "status-check")
              echo "ðŸ“Š Performing comprehensive status check..."
              
              # The analysis was already done in the previous step
              if [ -f orchestration_report.json ]; then
                echo "âœ… Status check completed - see orchestration report"
              else
                echo "âŒ Status check failed - no report generated"
                exit 1
              fi
              ;;
              
            "dependency-validation")
              echo "ðŸ”— Validating workflow dependencies..."
              
              if [ "${{ steps.dependency_validation.outputs.VALIDATION_STATUS }}" = "critical" ]; then
                echo "âŒ Critical dependency issues found"
                exit 1
              elif [ "${{ steps.dependency_validation.outputs.VALIDATION_STATUS }}" = "warning" ]; then
                echo "âš ï¸  Dependency warnings found - review recommended"
              else
                echo "âœ… All workflow dependencies are valid"
              fi
              ;;
              
            "workflow-health-check")
              echo "ðŸ¥ Performing workflow health check..."
              
              # Check if any workflows are in unhealthy state
              UNHEALTHY_WORKFLOWS=$(python scripts/workflows/orchestration_helper.py unhealthy-workflows)
              
              if [ -n "$UNHEALTHY_WORKFLOWS" ]; then
                echo "âŒ Unhealthy workflows detected: $UNHEALTHY_WORKFLOWS"
                
                # Record unhealthy workflows
                gh variable set UNHEALTHY_WORKFLOWS --body "$UNHEALTHY_WORKFLOWS" --repo ${{ github.repository }}
                gh variable set LAST_WORKFLOW_HEALTH_CHECK --body "$(date -u +%Y-%m-%dT%H:%M:%SZ)" --repo ${{ github.repository }}
                
                exit 1
              else
                echo "âœ… All workflows are healthy"
              fi
              ;;
              
            "emergency-coordination")
              echo "ðŸš¨ Performing emergency coordination..."
              
              # Check for stuck processes and coordinate emergency actions
              STUCK_DEPLOYMENT=$(gh variable get DEPLOYMENT_IN_PROGRESS --repo ${{ github.repository }} 2>/dev/null || echo "false")
              STUCK_RECOVERY=$(gh variable get RECOVERY_SESSION_ID --repo ${{ github.repository }} 2>/dev/null || echo "")
              
              EMERGENCY_ACTIONS_TAKEN=()
              
              if [ "$STUCK_DEPLOYMENT" = "true" ]; then
                DEPLOYMENT_START=$(gh variable get DEPLOYMENT_STARTED_AT --repo ${{ github.repository }} 2>/dev/null || echo "")
                if [ -n "$DEPLOYMENT_START" ]; then
                  # Check if deployment has been stuck for over 45 minutes
                  STUCK_DURATION=$(python scripts/workflows/orchestration_helper.py stuck-duration "$DEPLOYMENT_START")
                  
                  if [ "$STUCK_DURATION" -gt 2700 ]; then  # 45 minutes
                    echo "ðŸš¨ Clearing stuck deployment lock (stuck for ${STUCK_DURATION}s)"
                    gh variable set DEPLOYMENT_IN_PROGRESS --body "false" --repo ${{ github.repository }}
                    gh variable set EMERGENCY_DEPLOYMENT_LOCK_CLEARED --body "$(date -u +%Y-%m-%dT%H:%M:%SZ)" --repo ${{ github.repository }}
                    EMERGENCY_ACTIONS_TAKEN+=("deployment_lock_cleared")
                  fi
                fi
              fi
              
              if [ -n "$STUCK_RECOVERY" ]; then
                RECOVERY_START=$(gh variable get RECOVERY_START_TIME --repo ${{ github.repository }} 2>/dev/null || echo "")
                if [ -n "$RECOVERY_START" ]; then
                  # Check if recovery has been stuck for over 20 minutes
                  STUCK_DURATION=$(python scripts/workflows/orchestration_helper.py stuck-duration "$RECOVERY_START")
                  
                  if [ "$STUCK_DURATION" -gt 1200 ]; then  # 20 minutes
                    echo "ðŸš¨ Clearing stuck recovery session (stuck for ${STUCK_DURATION}s)"
                    gh variable delete RECOVERY_SESSION_ID --repo ${{ github.repository }} 2>/dev/null || true
                    gh variable set EMERGENCY_RECOVERY_SESSION_CLEARED --body "$(date -u +%Y-%m-%dT%H:%M:%SZ)" --repo ${{ github.repository }}
                    EMERGENCY_ACTIONS_TAKEN+=("recovery_session_cleared")
                  fi
                fi
              fi
              
              if [ ${#EMERGENCY_ACTIONS_TAKEN[@]} -gt 0 ]; then
                echo "ðŸš¨ Emergency actions taken: $(IFS=', '; echo "${EMERGENCY_ACTIONS_TAKEN[*]}")"
                gh variable set LAST_EMERGENCY_COORDINATION --body "$(date -u +%Y-%m-%dT%H:%M:%SZ)" --repo ${{ github.repository }}
                gh variable set EMERGENCY_ACTIONS_TAKEN --body "$(IFS=','; echo "${EMERGENCY_ACTIONS_TAKEN[*]}")" --repo ${{ github.repository }}
              else
                echo "âœ… No emergency coordination needed"
              fi
              ;;
              
            "state-synchronization")
              echo "ðŸ”„ Performing state synchronization..."
              
              # Synchronize state across workflows using helper script
              python scripts/workflows/orchestration_helper.py sync-state
              ;;
              
            *)
              echo "âŒ Unknown orchestration action: $ORCHESTRATION_ACTION"
              exit 1
              ;;
          esac
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Handle critical issues
        if: steps.dependency_validation.outputs.VALIDATION_STATUS == 'critical'
        run: |
          echo "ðŸš¨ Critical workflow orchestration issues detected!"
          
          # Extract critical recommendations
          CRITICAL_RECOMMENDATIONS=$(python scripts/workflows/orchestration_helper.py critical-recommendations)
          
          echo "Critical issues:"
          echo "$CRITICAL_RECOMMENDATIONS"
          
          # Record critical issues for alerting
          gh variable set ORCHESTRATION_CRITICAL_ALERT --body "$(date -u +%Y-%m-%dT%H:%M:%SZ)" --repo ${{ github.repository }}
          gh variable set ORCHESTRATION_CRITICAL_DETAILS --body "$CRITICAL_RECOMMENDATIONS" --repo ${{ github.repository }}
          
          # If this is an automated run, trigger emergency coordination
          if [ "$TRIGGER_TYPE" = "schedule" ]; then
            echo "ðŸš¨ Triggering emergency coordination due to critical issues..."
            
            gh workflow run workflow-orchestrator.yml \
              --repo ${{ github.repository }} \
              --field orchestration_action="emergency-coordination" \
              --field force_coordination=true
          fi
          
          echo "ðŸš¨ Critical issues require immediate attention!"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Generate orchestration summary
        if: always()
        run: |
          echo "ðŸ“‹ Generating workflow orchestration summary..."
          
          # Create comprehensive summary
          echo "## ðŸŽ¼ Workflow Orchestration Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Orchestration Session" >> $GITHUB_STEP_SUMMARY
          echo "- **Session ID**: \`$ORCHESTRATION_SESSION_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: $ORCHESTRATION_ACTION" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: $TARGET_WORKFLOW" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: $TRIGGER_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add validation results
          VALIDATION_STATUS="${{ steps.dependency_validation.outputs.VALIDATION_STATUS }}"
          CRITICAL_ISSUES="${{ steps.dependency_validation.outputs.CRITICAL_ISSUES }}"
          WARNING_ISSUES="${{ steps.dependency_validation.outputs.WARNING_ISSUES }}"
          
          echo "### Orchestration Results" >> $GITHUB_STEP_SUMMARY
          
          case "$VALIDATION_STATUS" in
            "success")
              echo "- **Overall Status**: âœ… **HEALTHY**" >> $GITHUB_STEP_SUMMARY
              ;;
            "warning")
              echo "- **Overall Status**: âš ï¸  **WARNING**" >> $GITHUB_STEP_SUMMARY
              ;;
            "critical")
              echo "- **Overall Status**: âŒ **CRITICAL**" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "- **Overall Status**: â“ **UNKNOWN**" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          
          echo "- **Critical Issues**: $CRITICAL_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- **Warning Issues**: $WARNING_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add workflow states if report exists
          if [ -f orchestration_report.json ]; then
            echo "### Workflow Health Status" >> $GITHUB_STEP_SUMMARY
            
            python scripts/workflows/orchestration_helper.py workflow-health-summary >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### System Consistency" >> $GITHUB_STEP_SUMMARY
            
            python scripts/workflows/orchestration_helper.py consistency-summary >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
            
            python scripts/workflows/orchestration_helper.py recommendations-summary >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸŽ¼ Workflow orchestration ensures proper coordination and sequencing of all CI/CD workflows.*" >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… Orchestration summary generated"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Cleanup orchestration session
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up orchestration session..."
          
          # Clear session variables
          gh variable delete ORCHESTRATION_SESSION_ID --repo ${{ github.repository }} 2>/dev/null || true
          
          # Update last completed orchestration
          gh variable set LAST_COMPLETED_ORCHESTRATION --body "$(date -u +%Y-%m-%dT%H:%M:%SZ)" --repo ${{ github.repository }}
          gh variable set LAST_COMPLETED_ORCHESTRATION_SESSION --body "$ORCHESTRATION_SESSION_ID" --repo ${{ github.repository }}
          gh variable set LAST_ORCHESTRATION_ACTION --body "$ORCHESTRATION_ACTION" --repo ${{ github.repository }}
          
          # Archive orchestration report
          if [ -f orchestration_report.json ]; then
            gh variable set LAST_ORCHESTRATION_REPORT --body "$(cat orchestration_report.json | head -c 8000)" --repo ${{ github.repository }}
          fi
          
          echo "âœ… Orchestration session cleanup completed"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}