name: Continuous Health Monitoring (Enhanced)

on:
  schedule:
    # Run health checks every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      force_recovery:
        description: 'Force recovery actions even if health checks pass'
        required: false
        type: boolean
        default: false
      skip_recovery:
        description: 'Skip recovery actions even if health checks fail'
        required: false
        type: boolean
        default: false
      debug_mode:
        description: 'Enable enhanced debugging'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TAILPASTE_URL: http://tailpaste:8080
  # Debug settings
  WORKFLOW_DEBUG_LEVEL: ${{ inputs.debug_mode && '4' || '3' }}

jobs:
  health-monitor:
    name: Continuous Health Monitoring
    runs-on:
      - tailpaste-runners
    
    permissions:
      contents: read
      actions: write
    
    concurrency:
      group: health-monitoring
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install GitHub CLI
        continue-on-error: true
        run: |
          chmod +x .github/scripts/install-gh-cli.sh
          .github/scripts/install-gh-cli.sh
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-health-monitor-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-health-monitor-
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          ping: docker.tailfa875.ts.net
      
      - name: Run pre-check diagnostics
        if: ${{ inputs.debug_mode == true }}
        continue-on-error: true
        run: |
          echo "ðŸ” Running pre-check diagnostics..."
          chmod +x .github/scripts/debug/diagnose-workflow.sh
          .github/scripts/debug/diagnose-workflow.sh full
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Initialize health monitoring session
        run: |
          chmod +x .github/scripts/health-check/init-monitoring-session.sh
          .github/scripts/health-check/init-monitoring-session.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Execute health checks
        id: health_checks
        continue-on-error: true
        run: |
          echo "ðŸ¥ Executing health checks..."
          chmod +x .github/scripts/health-check/execute-health-checks.sh
          
          if [[ "${{ inputs.debug_mode }}" == "true" ]]; then
            echo "ðŸ“‹ Running with enhanced debugging..."
            chmod +x .github/scripts/debug/enhanced-health-monitor.sh
            .github/scripts/debug/enhanced-health-monitor.sh --debug
          else
            .github/scripts/health-check/execute-health-checks.sh
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Record health check results
        continue-on-error: true
        run: |
          echo "ðŸ“Š Recording health check results..."
          chmod +x .github/scripts/health-check/record-health-results.sh
          .github/scripts/health-check/record-health-results.sh \
            "${{ steps.health_checks.outputs.OVERALL_HEALTH }}" \
            "Health check completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Evaluate recovery conditions
        id: recovery_evaluation
        continue-on-error: true
        run: |
          echo "ðŸ” Evaluating recovery conditions..."
          
          OVERALL_HEALTH="${{ steps.health_checks.outputs.OVERALL_HEALTH || 'unknown' }}"
          FORCE_RECOVERY="${{ inputs.force_recovery }}"
          SKIP_RECOVERY="${{ inputs.skip_recovery }}"
          
          SHOULD_TRIGGER_RECOVERY=false
          RECOVERY_REASON=""
          
          if [ "$SKIP_RECOVERY" = "true" ]; then
            echo "â­ï¸  Recovery skipped by manual input"
            RECOVERY_REASON="manually_skipped"
          elif [ "$FORCE_RECOVERY" = "true" ]; then
            echo "ðŸ”§ Recovery forced by manual input"
            SHOULD_TRIGGER_RECOVERY=true
            RECOVERY_REASON="manually_forced"
          elif [ "$OVERALL_HEALTH" = "unhealthy" ]; then
            echo "ðŸš¨ Health check failed - recovery needed"
            SHOULD_TRIGGER_RECOVERY=true
            RECOVERY_REASON="health_check_failed"
          elif [ "$OVERALL_HEALTH" = "degraded" ]; then
            echo "âš ï¸  Service degraded - checking history..."
            SHOULD_TRIGGER_RECOVERY=false
            RECOVERY_REASON="degraded_not_persistent"
          else
            echo "âœ… Health check passed - no recovery needed"
          fi
          
          echo "SHOULD_TRIGGER_RECOVERY=$SHOULD_TRIGGER_RECOVERY" >> $GITHUB_OUTPUT
          echo "RECOVERY_REASON=$RECOVERY_REASON" >> $GITHUB_OUTPUT
          
          if [ "$SHOULD_TRIGGER_RECOVERY" = "true" ]; then
            echo "ðŸ”§ Recovery will be triggered: $RECOVERY_REASON"
          else
            echo "â„¹ï¸  No recovery action needed: $RECOVERY_REASON"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Trigger recovery workflow
        if: steps.recovery_evaluation.outputs.SHOULD_TRIGGER_RECOVERY == 'true'
        continue-on-error: true
        run: |
          echo "ðŸš€ Triggering recovery workflow..."
          
          RECOVERY_REASON="${{ steps.recovery_evaluation.outputs.RECOVERY_REASON }}"
          OVERALL_HEALTH="${{ steps.health_checks.outputs.OVERALL_HEALTH || 'unknown' }}"
          
          if command -v gh &> /dev/null; then
            gh workflow run recovery.yml \
              --repo ${{ github.repository }} \
              --field health_status="$OVERALL_HEALTH" \
              --field recovery_reason="$RECOVERY_REASON" \
              --field triggered_by="health_monitor" || echo "âš ï¸  Workflow trigger had issues"
          else
            echo "âš ï¸  GitHub CLI not available - cannot trigger workflow"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate health monitoring summary
        if: always()
        run: |
          echo "ðŸ“‹ Generating health monitoring summary..."
          
          OVERALL_HEALTH="${{ steps.health_checks.outputs.OVERALL_HEALTH || 'unknown' }}"
          SHOULD_TRIGGER_RECOVERY="${{ steps.recovery_evaluation.outputs.SHOULD_TRIGGER_RECOVERY || 'false' }}"
          RECOVERY_REASON="${{ steps.recovery_evaluation.outputs.RECOVERY_REASON || 'unknown' }}"
          
          {
            echo "## ðŸ¥ Continuous Health Monitoring Report"
            echo ""
            echo "### Health Check Status"
            case "$OVERALL_HEALTH" in
              "healthy")
                echo "- **Overall Status**: âœ… HEALTHY"
                ;;
              "degraded")
                echo "- **Overall Status**: âš ï¸ DEGRADED"
                ;;
              "unhealthy")
                echo "- **Overall Status**: âŒ UNHEALTHY"
                ;;
              *)
                echo "- **Overall Status**: â“ UNKNOWN ($OVERALL_HEALTH)"
                ;;
            esac
            
            echo ""
            echo "### Recovery Decision"
            echo "- **Recovery Triggered**: $([ "$SHOULD_TRIGGER_RECOVERY" = "true" ] && echo "âœ… Yes" || echo "âŒ No")"
            echo "- **Reason**: $RECOVERY_REASON"
            echo ""
            
            echo "### Diagnostics"
            echo "- **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "- **Runner**: ${{ runner.name }}"
            echo "- **Debug Mode**: ${{ inputs.debug_mode && 'âœ… Enabled' || 'âŒ Disabled' }}"
            
            if [ "${{ inputs.debug_mode }}" = "true" ]; then
              echo ""
              echo "ðŸ“¦ Debug artifacts available in workflow run logs"
            fi
            
            echo ""
            echo "---"
            echo "*Next check: Scheduled in 5 minutes*"
          } >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… Summary generated"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload debug artifacts
        if: ${{ inputs.debug_mode && always() }}
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: health-monitor-debug-${{ github.run_id }}
          path: /tmp/health-check-artifacts
          retention-days: 3
      
      - name: Cleanup
        if: always()
        continue-on-error: true
        run: |
          echo "ðŸ§¹ Cleaning up..."
          
          # Clean up temporary files
          rm -rf /tmp/health-check-* 2>/dev/null || true
          rm -rf /tmp/workflow-debug* 2>/dev/null || true
          
          echo "âœ… Cleanup completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

