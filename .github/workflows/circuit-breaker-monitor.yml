name: Circuit Breaker Monitor

on:
  schedule:
    # Check circuit breaker status every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - status
          - check-thresholds
          - reset
          - export-logs
        default: status
      reset_failures:
        description: 'Reset failure counts when closing circuit breaker'
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Required permissions for the entire workflow
permissions:
  contents: read
  actions: write      # Required to set repository variables

jobs:
  circuit-breaker-monitor:
    name: Circuit Breaker Monitoring and Management
    runs-on:
      - tailpaste-runners
    
    # Required permissions for circuit breaker workflow
    permissions:
      contents: read
      actions: write      # Required to set repository variables
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install GitHub CLI
        run: |
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            sudo apt-get update
            sudo apt-get install -y gh
          else
            echo "GitHub CLI already installed"
          fi
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-circuit-breaker-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-circuit-breaker-
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Initialize monitoring session
        run: |
          source .github/scripts/circuit-breaker/cb-init-monitoring.sh "${{ inputs.action || 'status' }}" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Check circuit breaker status
        id: status_check
        run: |
          source .github/scripts/circuit-breaker/cb-check-status.sh "${{ github.repository }}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Check thresholds and auto-open if needed
        if: env.ACTION == 'check-thresholds' || github.event_name == 'schedule'
        run: |
          .github/scripts/circuit-breaker/cb-check-thresholds.sh "${{ github.repository }}"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Reset circuit breaker
        if: env.ACTION == 'reset'
        run: |
          .github/scripts/circuit-breaker/cb-reset.sh "${{ github.repository }}" "${{ inputs.reset_failures }}" "${{ github.actor }}"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Export circuit breaker logs
        if: env.ACTION == 'export-logs' || github.event_name == 'schedule'
        run: |
          .github/scripts/circuit-breaker/cb-export-logs.sh "${{ github.repository }}"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Upload circuit breaker export
        if: env.ACTION == 'export-logs' || github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          name: circuit-breaker-export-${{ env.MONITORING_SESSION_ID }}
          path: /tmp/circuit_breaker_export.json
          retention-days: 30
      
      - name: Generate monitoring summary
        if: always()
        run: |
          .github/scripts/circuit-breaker/cb-generate-summary.sh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          MONITORING_SESSION_ID: ${{ env.MONITORING_SESSION_ID }}
          ACTION: ${{ env.ACTION }}
          CB_STATUS: ${{ steps.status_check.outputs.CB_STATUS }}
          RECOVERY_FAILURES: ${{ steps.status_check.outputs.RECOVERY_FAILURES }}
          DEPLOYMENT_FAILURES: ${{ steps.status_check.outputs.DEPLOYMENT_FAILURES }}
          RECOVERY_THRESHOLD: ${{ steps.status_check.outputs.RECOVERY_THRESHOLD }}
          DEPLOYMENT_THRESHOLD: ${{ steps.status_check.outputs.DEPLOYMENT_THRESHOLD }}
          RECOVERY_EXCEEDED: ${{ steps.status_check.outputs.RECOVERY_EXCEEDED }}
          DEPLOYMENT_EXCEEDED: ${{ steps.status_check.outputs.DEPLOYMENT_EXCEEDED }}
          TRIGGER_SOURCE: ${{ github.event_name == 'schedule' && 'Scheduled' || github.actor }}
      
      - name: Cleanup monitoring session
        if: always()
        run: |
          .github/scripts/circuit-breaker/cb-cleanup.sh "${{ github.repository }}" "${{ env.MONITORING_SESSION_ID }}"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}